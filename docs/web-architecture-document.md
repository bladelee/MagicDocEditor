# AFFiNE AI ç¼–è¾‘å™¨æ¶æ„æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®åç§°

AFFiNE AI Editor - æ··åˆå­˜å‚¨æ¨¡å¼ AI æ–‡æ¡£ç¼–è¾‘å™¨

### é¡¹ç›®å®šä½

ä¸€ä¸ªè½»é‡çº§çš„ AI é©±åŠ¨æ–‡æ¡£ç¼–è¾‘å™¨ï¼Œæ”¯æŒæœ¬åœ°å­˜å‚¨å’Œ AFFiNE äº‘ç«¯åŒæ­¥ï¼Œæä¾›å®Œæ•´çš„å—ç¼–è¾‘å™¨å’Œè½»é‡çº§ç¼–è¾‘å™¨ä¸¤ç§æ¨¡å¼ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **åŒç¼–è¾‘å™¨æ¨¡å¼**ï¼šå®Œæ•´å—ç¼–è¾‘å™¨ + è½»é‡çº§ç¼–è¾‘å™¨
- âœ… **æ··åˆå­˜å‚¨**ï¼šæœ¬åœ° IndexedDB + AFFiNE äº‘ç«¯
- âœ… **AI åŠŸèƒ½é›†æˆ**ï¼šAI èŠå¤©åŠ©æ‰‹å’Œå†…å®¹ç”Ÿæˆ
- âœ… **å®æ—¶åŒæ­¥**ï¼šåŸºäº WebSocket + Yjs çš„å¢é‡åŒæ­¥
- âœ… **ç¦»çº¿ä¼˜å…ˆ**ï¼šæœ¬åœ°å­˜å‚¨ä¸ºä¸»ï¼Œäº‘ç«¯åŒæ­¥ä¸ºè¾…

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Blocksuiteç¼–è¾‘å™¨â”‚  â”‚è½»é‡çº§ç¼–è¾‘å™¨  â”‚  â”‚  AI èŠå¤©é¢æ¿ â”‚    â”‚
â”‚  â”‚(å®Œæ•´åŠŸèƒ½)     â”‚  â”‚(ç®€åŒ–åŠŸèƒ½)   â”‚  â”‚  (AI Chat)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†“                   â†“                   â†“             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Service Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚DocumentServiceâ”‚  â”‚ SyncManager â”‚  â”‚AuthService  â”‚     â”‚
â”‚  â”‚              â”‚  â”‚             â”‚  â”‚              â”‚     â”‚
â”‚  â”‚- CRUD æ“ä½œ   â”‚  â”‚- é˜Ÿåˆ—ç®¡ç†   â”‚  â”‚- Token ç®¡ç†  â”‚     â”‚
â”‚  â”‚- å­˜å‚¨æ¨¡å¼åˆ‡æ¢â”‚  â”‚- WebSocket  â”‚  â”‚- ç”¨æˆ·è®¤è¯   â”‚     â”‚
â”‚  â”‚- è‡ªåŠ¨ä¿å­˜    â”‚  â”‚- é‡è¯•æœºåˆ¶   â”‚  â”‚              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â†“                   â†“                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®è®¿é—®å±‚ (Storage Layer)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚LocalStorageAdapterâ”‚         â”‚AFFiNE WebSocket  â”‚         â”‚
â”‚  â”‚                  â”‚         â”‚Client            â”‚         â”‚
â”‚  â”‚- IndexedDB      â”‚         â”‚                  â”‚         â”‚
â”‚  â”‚- æœ¬åœ°ä¼˜å…ˆ       â”‚         â”‚- Socket.IO       â”‚         â”‚
â”‚  â”‚- ç¦»çº¿å¯ç”¨       â”‚         â”‚- Yjs åè®®        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è½¬æ¢å±‚ (Converter Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           YjsConverter (JSON â†” Yjs)                  â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚ â€¢ jsonToYjsUpdate()   - JSON â†’ Yjs äºŒè¿›åˆ¶           â”‚  â”‚
â”‚  â”‚ â€¢ yjsUpdateToJson()    - Yjs â†’ JSON                  â”‚  â”‚
â”‚  â”‚ â€¢ createYjsDoc()       - åˆ›å»ºæ–°æ–‡æ¡£                 â”‚  â”‚
â”‚  â”‚ â€¢ applyBlocksToYjs()   - æ›´æ–°æ–‡æ¡£                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. ç¼–è¾‘å™¨ç»„ä»¶ (Editor Components)

#### 1.1 BlocksuiteEditorï¼ˆå®Œæ•´å—ç¼–è¾‘å™¨ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/components/blocksuite-editor.tsx`

**åŠŸèƒ½ç‰¹æ€§ï¼š**

- å®Œæ•´çš„å—ç¼–è¾‘åŠŸèƒ½ï¼ˆæ®µè½ã€æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç ã€åˆ†å‰²çº¿ï¼‰
- æ”¯æŒå—çš„ CRUD æ“ä½œ
- AI å†…å®¹æ’å…¥
- è‡ªåŠ¨ä¿å­˜åˆ° DocumentService
- ä¸ AFFiNE åç«¯å®Œå…¨å…¼å®¹

**æ•°æ®ç»“æ„ï¼š**

```typescript
interface EditorBlock {
  id: string;
  type: BlockType; // 'paragraph' | 'heading' | 'list' | 'code' | 'divider'
  content: string;
  props?: Record<string, any>;
  children?: EditorBlock[];
}

interface DocumentData {
  id: string;
  title: string;
  blocks: EditorBlock[];
  createdAt: number;
  updatedAt: number;
}
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
// è·å–æ–‡æ¡£å†…å®¹
getDocument(): DocumentData

// æ’å…¥å—
insertBlock(index: number, block: EditorBlock): void

// æ›´æ–°å—å†…å®¹
updateBlock(blockId: string, content: string): void

// åˆ é™¤å—
deleteBlock(blockId: string): void

// æ’å…¥ AI ç”Ÿæˆçš„å†…å®¹
insertAIContent(content: string): void

// æ›¿æ¢é€‰ä¸­å†…å®¹
replaceSelection(content: string): void
```

#### 1.2 AIEditorï¼ˆè½»é‡çº§ç¼–è¾‘å™¨ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/components/ai-editor/AIEditor.tsx`

**åŠŸèƒ½ç‰¹æ€§ï¼š**

- ç®€åŒ–çš„ contentEditable ç¼–è¾‘å™¨
- è½»é‡çº§ UI
- é€‚åˆå¿«é€Ÿç¼–è¾‘
- AI èŠå¤©é¢æ¿é›†æˆ

**ä½¿ç”¨åœºæ™¯ï¼š**

- å¿«é€Ÿç¬”è®°
- ç®€å•æ–‡æ¡£ç¼–è¾‘
- èµ„æºå—é™ç¯å¢ƒ

---

### 2. å­˜å‚¨æœåŠ¡ (Storage Services)

#### 2.1 DocumentServiceï¼ˆæ–‡æ¡£æœåŠ¡ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/services/document/DocumentService.ts`

**èŒè´£ï¼š**

- ç»Ÿä¸€çš„æ–‡æ¡£ CRUD æ¥å£
- å­˜å‚¨æ¨¡å¼åˆ‡æ¢ï¼ˆæœ¬åœ° â†” AFFiNEï¼‰
- è‡ªåŠ¨ä¿å­˜æœºåˆ¶
- åŒæ­¥é˜Ÿåˆ—ç®¡ç†

**æ ¸å¿ƒ APIï¼š**

```typescript
class DocumentService {
  // åˆ›å»ºæ–‡æ¡£
  createDoc(title: string, options?: CreateDocOptions): Promise<string>;

  // è·å–æ–‡æ¡£
  getDoc(docId: string): Promise<Document | null>;

  // æ›´æ–°æ–‡æ¡£
  updateDoc(docId: string, updates: DocUpdates): Promise<void>;

  // åˆ é™¤æ–‡æ¡£
  deleteDoc(docId: string): Promise<void>;

  // åˆ—å‡ºæ–‡æ¡£
  listDocs(filter?: DocFilter): Promise<Document[]>;

  // æœç´¢æ–‡æ¡£
  searchDocs(query: string): Promise<Document[]>;

  // åˆ‡æ¢å­˜å‚¨æ¨¡å¼
  switchStorageMode(mode: StorageMode, config?: AFFineConfig): Promise<void>;

  // åŒæ­¥åˆ° AFFiNE
  syncToAFFine(): Promise<void>;

  // è·å–åŒæ­¥çŠ¶æ€
  getSyncStats(): any;
}
```

#### 2.2 LocalStorageAdapterï¼ˆæœ¬åœ°å­˜å‚¨é€‚é…å™¨ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/services/storage/LocalStorageAdapter.ts`

**æŠ€æœ¯å®ç°ï¼š**

- ä½¿ç”¨ IndexedDB å­˜å‚¨æ–‡æ¡£
- æ•°æ®åº“åç§°ï¼š`ai-editor-local`
- ç‰ˆæœ¬ï¼š1
- å­˜å‚¨å¯¹è±¡ï¼š
  - `docs` - æ–‡æ¡£å­˜å‚¨
  - `yjs-updates` - Yjs æ›´æ–°å†å²ï¼ˆç”¨äºå¢é‡åŒæ­¥ï¼‰

**æ•°æ®ç»“æ„ï¼š**

```typescript
interface DBDocument extends Document {
  id: string;
  workspaceId?: string;
  updatedAt: number;
  createdAt: number;
}
```

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- è‡ªåŠ¨åˆ›å»ºæ–‡æ¡£ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- å¢é‡æ›´æ–°æ”¯æŒ
- å†å²ç‰ˆæœ¬ç®¡ç†
- ç¦»çº¿ä¼˜å…ˆè®¾è®¡

---

### 3. åŒæ­¥æœåŠ¡ (Sync Services)

#### 3.1 SyncManagerï¼ˆåŒæ­¥ç®¡ç†å™¨ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/services/sync/SyncManager.ts`

**è®¾è®¡æ¨¡å¼ï¼š**

- é˜Ÿåˆ—æ¨¡å¼ï¼šå¼‚æ­¥å¤„ç†åŒæ­¥æ“ä½œ
- é‡è¯•æœºåˆ¶ï¼šæœ€å¤šé‡è¯• 3 æ¬¡
- é”™è¯¯æ¢å¤ï¼šå¤±è´¥æ“ä½œä¿ç•™åœ¨é˜Ÿåˆ—ä¸­

**åŒæ­¥æµç¨‹ï¼š**

```
1. ç”¨æˆ·ç¼–è¾‘æ–‡æ¡£
   â†“
2. DocumentService æ›´æ–°æœ¬åœ°å­˜å‚¨ (LocalStorageAdapter)
   â†“
3. æ·»åŠ æ“ä½œåˆ°åŒæ­¥é˜Ÿåˆ— (SyncManager.enqueue)
   â†“
4. è½¬æ¢ä¸º Yjs æ ¼å¼ (YjsConverter)
   â†“
5. é€šè¿‡ WebSocket å‘é€åˆ° AFFiNE (AFFiNEWebSocketClient)
   â†“
6. æ¥æ”¶ç¡®è®¤å¹¶æ›´æ–°åŒæ­¥çŠ¶æ€
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
class SyncManager {
  // é…ç½® AFFiNE è¿æ¥
  async setConfig(config: AFFineConfig): Promise<void>;

  // æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
  enqueue(operation: SyncOperation): void;

  // å¤„ç†åŒæ­¥é˜Ÿåˆ—
  async process(docId?: string): Promise<void>;

  // è·å–åŒæ­¥çŠ¶æ€
  getStatus(docId: string): SyncStatus;

  // è·å–ç»Ÿè®¡ä¿¡æ¯
  getStats(): SyncStats;

  // æ¸…ç©ºé˜Ÿåˆ—
  clearQueue(): void;

  // æ–­å¼€è¿æ¥
  async disconnect(): Promise<void>;
}
```

#### 3.2 AFFiNEWebSocketClientï¼ˆWebSocket å®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/services/sync/AFFiNEWebSocketClient.ts`

**æŠ€æœ¯æ ˆï¼š**

- Socket.IO Client
- ç«¯ç‚¹ï¼š`http://localhost:10003`ï¼ˆé€šè¿‡ SSH tunnelï¼‰
- ä¼ è¾“åè®®ï¼šWebSocketï¼ˆä¼˜å…ˆï¼‰/ Pollingï¼ˆå¤‡é€‰ï¼‰

**WebSocket äº‹ä»¶ï¼š**

**å®¢æˆ·ç«¯å‘é€äº‹ä»¶ï¼š**

```typescript
// åŠ å…¥å·¥ä½œç©ºé—´
'space:join': {
  spaceType: 'workspace',
  spaceId: string,
  clientVersion: string
}

// æ¨é€æ–‡æ¡£æ›´æ–°
'space:push-doc-update': {
  spaceType: 'workspace',
  spaceId: string,
  docId: string,
  update: string  // Base64 ç¼–ç çš„ Yjs äºŒè¿›åˆ¶
}

// åŠ è½½æ–‡æ¡£
'space:load-doc': {
  spaceType: 'workspace',
  spaceId: string,
  docId: string,
  stateVector?: string  // å¯é€‰ï¼Œç”¨äºå¢é‡åŒæ­¥
}

// åˆ é™¤æ–‡æ¡£
'space:delete-doc': {
  spaceType: 'workspace',
  spaceId: string,
  docId: string
}

// ç¦»å¼€å·¥ä½œç©ºé—´
'space:leave': {
  spaceType: 'workspace',
  spaceId: string
}
```

**æœåŠ¡å™¨å¹¿æ’­äº‹ä»¶ï¼š**

```typescript
'space:broadcast-doc-update': {
  spaceType: string,
  spaceId: string,
  docId: string,
  update: string,      // Base64 ç¼–ç çš„ Yjs æ›´æ–°
  timestamp: number,
  editor: string
}
```

**è®¤è¯æœºåˆ¶ï¼š**

```typescript
auth: cb => {
  cb({ token: config.token });
};
```

#### 3.3 YjsConverterï¼ˆæ ¼å¼è½¬æ¢å™¨ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/services/sync/YjsConverter.ts`

**æŠ€æœ¯å®ç°ï¼š**

- Yjsï¼šCRDTï¼ˆConflict-free Replicated Data Typeï¼‰åº“
- ç”¨äºå¤„ç†å¤šç”¨æˆ·åä½œå’Œå†²çªè§£å†³

**æ•°æ®è½¬æ¢æµç¨‹ï¼š**

```typescript
// JSON â†’ Yjs äºŒè¿›åˆ¶
const { update } = YjsConverter.createYjsDoc(docId, doc.title, doc.blocks);
// update: Uint8Array

// Yjs â†’ JSON
const jsonDoc = YjsConverter.yjsUpdateToJson(update);
// jsonDoc: JSONDocument
```

**Yjs æ–‡æ¡£ç»“æ„ï¼š**

```typescript
{
  meta: YMap {
    id: string,
    title: string,
    createdAt: number,
    updatedAt: number
  },
  blocks: YArray [
    Block { id, flavour, type, text, props, children },
    ...
  ]
}
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
class YjsConverter {
  // JSON â†’ Yjs Update
  static jsonToYjsUpdate(doc: JSONDocument): Uint8Array;

  // Yjs Update â†’ JSON
  static yjsUpdateToJson(update: Uint8Array): JSONDocument | null;

  // åˆ›å»ºæ–°æ–‡æ¡£
  static createYjsDoc(docId: string, title: string, blocks: Block[]): { ydoc: Y.Doc; update: Uint8Array };

  // æ›´æ–°ç°æœ‰æ–‡æ¡£
  static applyBlocksToYjs(ydoc: Y.Doc, docId: string, title: string, blocks: Block[]): Uint8Array;

  // è®¡ç®—çŠ¶æ€å‘é‡ï¼ˆç”¨äºå¢é‡åŒæ­¥ï¼‰
  static getStateVector(ydoc: Y.Doc): Uint8Array;

  // è®¡ç®—å·®å¼‚
  static getDiff(ydoc: Y.Doc, stateVector: Uint8Array): Uint8Array;
}
```

---

### 4. è®¤è¯æœåŠ¡ (Authentication Services)

#### 4.1 AuthServiceï¼ˆè®¤è¯æœåŠ¡ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `src/web/services/auth.ts`

**åŠŸèƒ½ï¼š**

- Token ç®¡ç†
- ç”¨æˆ·è®¤è¯çŠ¶æ€
- Workspace ID ç®¡ç†

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```typescript
class AuthService {
  // ä¿å­˜ token
  saveToken(token: string, workspaceId?: string): void;

  // è·å– token
  getToken(): string | null;

  // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
  isAuthenticated(): boolean;

  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUser(): AuthUser | null;

  // ç™»å‡º
  async signOut(): Promise<void>;

  // è·å– workspace IDs
  getWorkspaces(): string[];
}
```

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### åˆ›å»ºæ–‡æ¡£æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"æ–°å»ºæ–‡æ¡£"
   â†“
AllPagesPage.handleCreate()
   â†“
DocumentService.createDoc(title, options)
   â†“
LocalStorageAdapter.createDoc(doc)  // ä¿å­˜åˆ° IndexedDB
   â†“
SyncManager.enqueue({ type: 'create', doc })
   â†“
SyncManager.process()
   â†“
YjsConverter.createYjsDoc()  // è½¬æ¢ä¸º Yjs æ ¼å¼
   â†“
AFFiNEWebSocketClient.pushDocUpdate()  // WebSocket å‘é€
   â†“
AFFiNE åç«¯æ¥æ”¶å¹¶ä¿å­˜
   â†“
è¿”å› timestamp
   â†“
æ ‡è®°åŒæ­¥å®Œæˆ
```

### ç¼–è¾‘æ–‡æ¡£æµç¨‹

```
ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥å†…å®¹
   â†“
BlocksuiteEditor.updateBlockContent()
   â†“
setDocument() æ›´æ–°æœ¬åœ°çŠ¶æ€
   â†“
è‡ªåŠ¨ä¿å­˜è§¦å‘ï¼ˆ1ç§’å»¶è¿Ÿï¼‰
   â†“
DocumentService.updateDoc(docId, updates)
   â†“
LocalStorageAdapter.updateDoc()  // æ›´æ–° IndexedDB
   â†“
SyncManager.enqueue({ type: 'update', docId, updates })
   â†“
åå°å¼‚æ­¥å¤„ç†ï¼š
   YjsConverter.applyBlocksToYjs()
   â†“
AFFiNEWebSocketClient.pushDocUpdate()
   â†“
AFFiNE åç«¯å¹¿æ’­æ›´æ–°
   â†“
å…¶ä»–å®¢æˆ·ç«¯æ¥æ”¶å¹¶åˆå¹¶
```

### åŒæ­¥æ¥æ”¶æµç¨‹

```
AFFiNE åç«¯å¹¿æ’­æ›´æ–°
   â†“
AFFiNEWebSocketClient.on('space:broadcast-doc-update')
   â†“
SyncManager.handleServerUpdate()
   â†“
YjsConverter.yjsUpdateToJson()  // è½¬å› JSON
   â†“
LocalStorageAdapter.updateDoc()  // æ›´æ–°æœ¬åœ°å­˜å‚¨
   â†“
è§¦å‘ UI åˆ·æ–°
```

---

## ğŸ”Œ å­˜å‚¨æ¨¡å¼è¯¦è§£

### æœ¬åœ°æ¨¡å¼ï¼ˆLocal Modeï¼‰

**ç‰¹ç‚¹ï¼š**

- âœ… å®Œå…¨ç¦»çº¿å¯ç”¨
- âœ… æ— éœ€ AFFiNE è´¦å·
- âœ… å¿«é€Ÿå“åº”
- âŒ æ— äº‘ç«¯å¤‡ä»½
- âŒ æ— æ³•è·¨è®¾å¤‡åŒæ­¥

**å­˜å‚¨ä½ç½®ï¼š**

- æµè§ˆå™¨ IndexedDB
- æ•°æ®åº“åï¼š`ai-editor-local`

**æ•°æ®æµï¼š**

```
ç”¨æˆ·æ“ä½œ â†’ LocalStorageAdapter â†’ IndexedDB
```

### AFFiNE åŒæ­¥æ¨¡å¼ï¼ˆAFFiNE Sync Modeï¼‰

**ç‰¹ç‚¹ï¼š**

- âœ… æœ¬åœ° + äº‘ç«¯åŒé‡å­˜å‚¨
- âœ… è·¨è®¾å¤‡åŒæ­¥
- âœ… æ”¯æŒåä½œç¼–è¾‘
- âœ… AI åŠŸèƒ½å¢å¼º
- âš ï¸ éœ€è¦ AFFiNE è´¦å·
- âš ï¸ éœ€è¦ç½‘ç»œè¿æ¥

**å­˜å‚¨ä½ç½®ï¼š**

- æœ¬åœ°ï¼šIndexedDB
- äº‘ç«¯ï¼šAFFiNE åç«¯ï¼ˆé€šè¿‡ WebSocketï¼‰

**æ•°æ®æµï¼š**

```
ç”¨æˆ·æ“ä½œ â†’ LocalStorageAdapter â†’ IndexedDB
                    â†“
              SyncManager â†’ WebSocket â†’ AFFiNE äº‘ç«¯
```

### æ¨¡å¼åˆ‡æ¢

**ä»æœ¬åœ°åˆ‡æ¢åˆ° AFFiNEï¼š**

```typescript
DocumentService.switchStorageMode('affine', {
  workspaceId: 'xxx',
  token: 'yyy',
});
```

**ä» AFFiNE åˆ‡æ¢åˆ°æœ¬åœ°ï¼š**

```typescript
DocumentService.switchStorageMode('local');
```

---

## ğŸ§ª åŠŸèƒ½éªŒæ”¶æµ‹è¯•æŒ‡å—

### æµ‹è¯•ç¯å¢ƒå‡†å¤‡

#### 1.1 åç«¯ç¯å¢ƒ

**AFFiNE åç«¯ï¼ˆé€šè¿‡ SSH tunnelï¼‰ï¼š**

```bash
# æ£€æŸ¥ SSH tunnel æ˜¯å¦è¿è¡Œ
lsof -i:10003

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# COMMAND   PID   USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
# ssh     12345  user   3u   IPv4  0x0      0t0  TCP *:10003 (LISTEN)
```

#### 1.2 å‰ç«¯ç¯å¢ƒ

**å¼€å‘æœåŠ¡å™¨ï¼š**

```bash
# å‰ç«¯åº”è¯¥è¿è¡Œåœ¨ 3004 ç«¯å£
# è®¿é—®ï¼šhttp://localhost:3004

# æ£€æŸ¥è¿è¡ŒçŠ¶æ€
lsof -i:3004

# åº”è¯¥çœ‹åˆ°ï¼š
# COMMAND    PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
# MainThrea 1311 user   22u  IPv6  121017  0t0  TCP *:3004 (LISTEN)
```

---

### æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯• 1ï¼šæœ¬åœ°æ¨¡å¼åŸºæœ¬åŠŸèƒ½

**ç›®æ ‡ï¼š** éªŒè¯æœ¬åœ°æ¨¡å¼ä¸‹çš„æ–‡æ¡£ CRUD åŠŸèƒ½

**æ­¥éª¤ï¼š**

```
1. è®¿é—®ï¼šhttp://localhost:3004/#/workspace/demo/all

2. ç‚¹å‡»"+ æ–°å»ºæ–‡æ¡£"æŒ‰é’®

3. è¾“å…¥æ ‡é¢˜ï¼š"æœ¬åœ°æµ‹è¯•æ–‡æ¡£"

4. ç‚¹å‡»"åˆ›å»º"

5. ç‚¹å‡»æ–‡æ¡£å¡ç‰‡çš„"å®Œæ•´"æŒ‰é’®æ‰“å¼€ç¼–è¾‘å™¨

6. åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ å†…å®¹ï¼š
   - æ·»åŠ æ ‡é¢˜ï¼š"æµ‹è¯•æ ‡é¢˜"
   - æ·»åŠ æ®µè½ï¼š"è¿™æ˜¯æµ‹è¯•å†…å®¹"
   - æ·»åŠ åˆ—è¡¨é¡¹ï¼š"åˆ—è¡¨é¡¹ 1"

7. è¿”å›æ‰€æœ‰æ–‡æ¡£é¡µé¢
```

**é¢„æœŸç»“æœï¼š**

- âœ… æ–‡æ¡£åˆ›å»ºæˆåŠŸ
- âœ… æ–‡æ¡£åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
- âœ… ç¼–è¾‘å™¨æ­£å¸¸å·¥ä½œ
- âœ… å†…å®¹ä¿å­˜æˆåŠŸ
- âœ… æ§åˆ¶å°æ— é”™è¯¯

**æ§åˆ¶å°æ—¥å¿—ï¼š**

```javascript
ğŸ“ Document [doc-id] not found, creating...
âœ… Document created: [doc-id]
ğŸ’¾ Document auto-saved: [doc-id]
```

---

#### æµ‹è¯• 2ï¼šAFFiNE è®¤è¯é…ç½®

**ç›®æ ‡ï¼š** éªŒè¯ AFFiNE è®¤è¯åŠŸèƒ½

**å‰ç½®æ¡ä»¶ï¼š**

- AFFiNE åç«¯æ­£å¸¸è¿è¡Œ
- æ‹¥æœ‰æœ‰æ•ˆçš„ AFFiNE è´¦å·

**æ­¥éª¤ï¼š**

```
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰

2. åœ¨ AFFiNE ç½‘ç«™ç™»å½•

3. åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼š
   - åˆ‡æ¢åˆ° Application æ ‡ç­¾
   - å·¦ä¾§èœå•é€‰æ‹© Cookies
   - æ‰¾åˆ°å¹¶å¤åˆ¶ affine-session æˆ– better-auth.session_token çš„å€¼

4. è®¿é—®ï¼šhttp://localhost:3004/#/workspace/demo/settings

5. åœ¨"è®¤è¯ Token"è¾“å…¥æ¡†ç²˜è´´ token

6. è¾“å…¥é‚®ç®±ï¼ˆå¯é€‰ï¼‰

7. ç‚¹å‡»"ä¿å­˜ Token"æŒ‰é’®
```

**é¢„æœŸç»“æœï¼š**

- âœ… å¼¹å‡ºç¡®è®¤æ¶ˆæ¯ï¼š"âœ… è®¤è¯ token å·²ä¿å­˜ï¼"
- âœ… æ˜¾ç¤ºå·²è®¤è¯ç”¨æˆ·é‚®ç®±
- âœ… ä¸‹æ–¹æ˜¾ç¤º Workspace åˆ—è¡¨
- âœ… æ§åˆ¶å°æ˜¾ç¤ºæˆåŠŸçš„ GraphQL è¯·æ±‚

**æ§åˆ¶å°æ—¥å¿—ï¼š**

```javascript
AuthLink: token = [tokenå‰20ä¸ªå­—ç¬¦]...
=== GraphQL Request ===
URI: http://localhost:10003/graphql
...
=== GraphQL Response ===
Status: 200
...
âœ… Workspaces saved to localStorage: [workspace-id-1, workspace-id-2]
```

---

#### æµ‹è¯• 3ï¼šAFFiNE åŒæ­¥æ¨¡å¼ - æ–‡æ¡£åˆ›å»º

**ç›®æ ‡ï¼š** éªŒè¯æ–‡æ¡£åˆ›å»ºå’ŒåŒæ­¥åˆ° AFFiNE

**å‰ç½®æ¡ä»¶ï¼š**

- å·²å®Œæˆæµ‹è¯• 2ï¼ˆè®¤è¯é…ç½®ï¼‰
- å·²è·å– Workspace ID

**æ­¥éª¤ï¼š**

```
1. åœ¨è®¾ç½®é¡µé¢å¤åˆ¶ Workspace ID

2. è¿”å›æ‰€æœ‰æ–‡æ¡£é¡µé¢

3. ç‚¹å‡»"âš™ï¸ è®¾ç½®"æŒ‰é’®

4. åœ¨å­˜å‚¨æ¨¡å¼éƒ¨åˆ†ï¼Œç‚¹å‡»"â˜ï¸ AFFiNE åŒæ­¥æ¨¡å¼"

5. è¾“å…¥ Workspace ID
   - Token åº”è¯¥è‡ªåŠ¨å¡«å……

6. åˆ›å»ºæ–°æ–‡æ¡£ï¼š
   - æ ‡é¢˜ï¼š"åŒæ­¥æµ‹è¯•æ–‡æ¡£"
   - ç‚¹å‡»"åˆ›å»º"

7. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
```

**é¢„æœŸç»“æœï¼š**

- âœ… WebSocket è¿æ¥æˆåŠŸ
- âœ… åŠ å…¥ workspace æˆåŠŸ
- âœ… æ–‡æ¡£åˆ›å»ºåˆ°æœ¬åœ°
- âœ… æ–‡æ¡£åŒæ­¥åˆ° AFFiNE
- âœ… æ˜¾ç¤ºåŒæ­¥çŠ¶æ€ï¼šå¾…åŒæ­¥: 0 â€¢ å·²å®Œæˆ: 1

**æ§åˆ¶å°æ—¥å¿—ï¼š**

```javascript
ğŸ”Œ Connecting to AFFiNE WebSocket: http://localhost:10003
âœ… WebSocket connected
âœ… Joined workspace: [workspace-id]
âœ… Connected to AFFiNE WebSocket
âœ… SyncManager configured for workspace: [workspace-id]
ğŸ“ Document [doc-id] not found, creating...
âœ… Document created: [doc-id]
ğŸ“¤ Added to sync queue: create [uuid]
ğŸ”„ Processing 1 sync items...
âœ… Doc update pushed to AFFiNE: [doc-id] timestamp: [timestamp]
âœ… Document created in AFFiNE: [doc-id]
âœ… Sync completed: [uuid]
```

**éªŒæ”¶ç‚¹ï¼š**

- [ ] WebSocket è¿æ¥æˆåŠŸ
- [ ] æ–‡æ¡£åœ¨æœ¬åœ° IndexedDB ä¸­
- [ ] æ–‡æ¡£åœ¨ AFFiNE åç«¯å¯æŸ¥çœ‹

---

#### æµ‹è¯• 4ï¼šAFFiNE åŒæ­¥æ¨¡å¼ - æ–‡æ¡£ç¼–è¾‘

**ç›®æ ‡ï¼š** éªŒè¯ç¼–è¾‘å†…å®¹å®æ—¶åŒæ­¥

**æ­¥éª¤ï¼š**

````
1. æ‰“å¼€"åŒæ­¥æµ‹è¯•æ–‡æ¡£"

2. åœ¨å®Œæ•´ç¼–è¾‘å™¨ä¸­æ·»åŠ å†…å®¹ï¼š
   - æ·»åŠ æ ‡é¢˜ï¼š"ç« èŠ‚ä¸€"
   - æ·»åŠ æ®µè½ï¼š"è¿™æ˜¯ç¬¬ä¸€ç« çš„å†…å®¹"
   - æ·»åŠ ä»£ç å—ï¼š
     ```javascript
     console.log('Hello, AFFiNE!');
     ```

3. ç­‰å¾…è‡ªåŠ¨ä¿å­˜ï¼ˆ1ç§’ï¼‰

4. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º

5. è¿”å›æ–‡æ¡£åˆ—è¡¨ï¼ŒæŸ¥çœ‹åŒæ­¥çŠ¶æ€
````

**é¢„æœŸç»“æœï¼š**

- âœ… å†…å®¹è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°
- âœ… æ›´æ–°åŒæ­¥åˆ° AFFiNE
- âœ… æ§åˆ¶å°æ˜¾ç¤ºåŒæ­¥æ—¥å¿—
- âœ… åŒæ­¥è®¡æ•°å¢åŠ 

**æ§åˆ¶å°æ—¥å¿—ï¼š**

```javascript
ğŸ’¾ Document auto-saved: [doc-id]
ğŸ“¤ Added to sync queue: update [uuid]
ğŸ”„ Processing 1 sync items...
âœ… Doc update pushed to AFFiNE: [doc-id] timestamp: [timestamp]
âœ… Document updated in AFFiNE: [doc-id]
âœ… Sync completed: [uuid]
```

---

#### æµ‹è¯• 5ï¼šåŒå‘åŒæ­¥éªŒè¯

**ç›®æ ‡ï¼š** éªŒè¯ä» AFFiNE åˆ°æœ¬åœ°çš„åŒæ­¥

**æ­¥éª¤ï¼š**

```
1. åœ¨ AFFiNE å®˜æ–¹ç•Œé¢æ‰“å¼€åŒæ­¥çš„æ–‡æ¡£

2. åœ¨ AFFiNE ä¸­ç¼–è¾‘æ–‡æ¡£

3. è¿”å› AI ç¼–è¾‘å™¨

4. æ‰“å¼€åŒä¸€æ–‡æ¡£

5. è§‚å¯Ÿå†…å®¹æ˜¯å¦æ›´æ–°
```

**é¢„æœŸç»“æœï¼š**

- âœ… æœ¬åœ°æ–‡æ¡£è‡ªåŠ¨æ›´æ–°
- âœ… æ§åˆ¶å°æ˜¾ç¤ºæ¥æ”¶æ›´æ–°æ—¥å¿—
- âœ… ç¼–è¾‘å™¨æ˜¾ç¤ºæœ€æ–°å†…å®¹

**æ§åˆ¶å°æ—¥å¿—ï¼š**

```javascript
ğŸ“¥ Received update from AFFiNE: [doc-id]
âœ… Local document updated from AFFiNE: [doc-id]
```

---

#### æµ‹è¯• 6ï¼šç¦»çº¿åŠŸèƒ½

**ç›®æ ‡ï¼š** éªŒè¯ç¦»çº¿çŠ¶æ€ä¸‹çš„åŠŸèƒ½

**æ­¥éª¤ï¼š**

```
1. æ–­å¼€ç½‘ç»œæˆ–å…³é—­ SSH tunnel

2. å°è¯•åˆ›å»ºæ–°æ–‡æ¡£

3. ç¼–è¾‘ç°æœ‰æ–‡æ¡£

4. è§‚å¯Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ

5. æ¢å¤ç½‘ç»œ

6. è§‚å¯Ÿè‡ªåŠ¨åŒæ­¥
```

**é¢„æœŸç»“æœï¼š**

- âœ… ç¦»çº¿çŠ¶æ€ä¸‹å¯ä»¥åˆ›å»ºæ–‡æ¡£
- âœ… ç¦»çº¿çŠ¶æ€ä¸‹å¯ä»¥ç¼–è¾‘æ–‡æ¡£
- âœ… æ¢å¤ç½‘ç»œåè‡ªåŠ¨åŒæ­¥
- âœ… åŒæ­¥é˜Ÿåˆ—æ­£å¸¸å¤„ç†

**æ§åˆ¶å°æ—¥å¿—ï¼š**

```javascript
// ç¦»çº¿æ—¶
ğŸ“ Document [doc-id] not found, creating...
âœ… Document created: [doc-id]
ğŸ“¤ Added to sync queue: create [uuid]
â¸ï¸ Sync already processing or not configured

// æ¢å¤ç½‘ç»œå
âœ… Connected to AFFiNE WebSocket
ğŸ”„ Processing 1 sync items...
âœ… Sync completed: [uuid]
```

---

#### æµ‹è¯• 7ï¼šè½»é‡çº§ç¼–è¾‘å™¨

**ç›®æ ‡ï¼š** éªŒè¯è½»é‡çº§ç¼–è¾‘å™¨åŠŸèƒ½

**æ­¥éª¤ï¼š**

```
1. åœ¨æ–‡æ¡£åˆ—è¡¨ï¼Œç‚¹å‡»æ–‡æ¡£çš„"è½»é‡"æŒ‰é’®

2. æµ‹è¯•ç¼–è¾‘åŠŸèƒ½

3. æµ‹è¯• AI èŠå¤©é¢æ¿ï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
```

**é¢„æœŸç»“æœï¼š**

- âœ… ç¼–è¾‘å™¨æ­£å¸¸åŠ è½½
- âœ… å¯ä»¥ç¼–è¾‘å†…å®¹
- âœ… AI é¢æ¿æ­£å¸¸æ˜¾ç¤º

---

#### æµ‹è¯• 8ï¼šé”™è¯¯å¤„ç†å’Œæ¢å¤

**ç›®æ ‡ï¼š** éªŒè¯é”™è¯¯åœºæ™¯çš„å¤„ç†

**æµ‹è¯•åœºæ™¯ï¼š**

**8.1 æ— æ•ˆ Token**

```
1. ä½¿ç”¨é”™è¯¯çš„ Token

2. å°è¯•åŒæ­¥

é¢„æœŸï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä¸å½±å“æœ¬åœ°åŠŸèƒ½
```

**8.2 æ— æ•ˆ Workspace ID**

```
1. ä½¿ç”¨ä¸å­˜åœ¨çš„ Workspace ID

2. å°è¯•åŒæ­¥

é¢„æœŸï¼šæ˜¾ç¤º"Workspace not found"é”™è¯¯
```

**8.3 ç½‘ç»œä¸­æ–­**

```
1. ç¼–è¾‘æ–‡æ¡£æ—¶ä¸­æ–­ç½‘ç»œ

2. æ¢å¤ç½‘ç»œ

é¢„æœŸï¼šæ“ä½œä¿å­˜åœ¨æœ¬åœ°ï¼Œæ¢å¤åè‡ªåŠ¨åŒæ­¥
```

**8.4 å¹¶å‘ç¼–è¾‘**

```
1. åœ¨ AI ç¼–è¾‘å™¨å’Œ AFFiNE å®˜æ–¹ç•Œé¢åŒæ—¶æ‰“å¼€æ–‡æ¡£

2. åŒæ—¶ç¼–è¾‘

é¢„æœŸï¼šä¸¤ä¸ªå®¢æˆ·ç«¯çš„å†…å®¹éƒ½ä¿ç•™ï¼ˆYjs CRDT åˆå¹¶ï¼‰
```

---

### æ€§èƒ½æµ‹è¯•

#### æµ‹è¯• 9ï¼šå¤§æ–‡æ¡£å¤„ç†

**ç›®æ ‡ï¼š** éªŒè¯å¤§æ–‡æ¡£çš„æ€§èƒ½

**æ­¥éª¤ï¼š**

```
1. åˆ›å»ºåŒ…å«å¤§é‡å—çš„æ–‡æ¡£ï¼ˆä¾‹å¦‚ 100+ ä¸ªæ®µè½ï¼‰

2. ç¼–è¾‘æ–‡æ¡£

3. è§‚å¯Ÿæ€§èƒ½
```

**é¢„æœŸæŒ‡æ ‡ï¼š**

- âœ… ç¼–è¾‘å“åº”æ—¶é—´ < 100ms
- âœ… è‡ªåŠ¨ä¿å­˜ä¸é˜»å¡ UI
- âœ… åŒæ­¥å»¶è¿Ÿ < 1s

---

#### æµ‹è¯• 10ï¼šå¹¶å‘æ“ä½œ

**ç›®æ ‡ï¼š** éªŒè¯å¤šä¸ªæ–‡æ¡£åŒæ—¶åŒæ­¥

**æ­¥éª¤ï¼š**

```
1. åˆ›å»º 5 ä¸ªæ–‡æ¡£

2. å¿«é€Ÿç¼–è¾‘æ‰€æœ‰æ–‡æ¡£

3. è§‚å¯ŸåŒæ­¥é˜Ÿåˆ—
```

**é¢„æœŸç»“æœï¼š**

- âœ… æ‰€æœ‰æ–‡æ¡£æ­£å¸¸åŒæ­¥
- âœ… åŒæ­¥é˜Ÿåˆ—æ­£å¸¸å·¥ä½œ
- âœ… æ— æ•°æ®ä¸¢å¤±

---

## ğŸ› æ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜

#### é—®é¢˜ 1ï¼šWebSocket è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**

```
âŒ WebSocket connection error: Error: socket hang up
```

**åŸå› ï¼š**

- SSH tunnel (10003ç«¯å£) æœªè¿è¡Œ

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# æ£€æŸ¥ SSH tunnel
lsof -i:10003

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œé‡æ–°å»ºç«‹ SSH tunnel
ssh -L 10003:localhost:3000 user@remote-server
```

---

#### é—®é¢˜ 2ï¼šè®¤è¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**

```
âŒ Failed to join workspace: Authentication failed
```

**åŸå› ï¼š**

- Token æ— æ•ˆæˆ–è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆï¼š**

1. é‡æ–°ä» AFFiNE ç½‘ç«™è·å– token
2. ç¡®ä¿å¤åˆ¶å®Œæ•´çš„ token å€¼
3. åœ¨è®¾ç½®é¡µé¢é‡æ–°ä¿å­˜ token

---

#### é—®é¢˜ 3ï¼šæ–‡æ¡£æœªæ‰¾åˆ°

**é”™è¯¯ä¿¡æ¯ï¼š**

```
âŒ Sync failed: Document [doc-id] not found in local storage
```

**åŸå› ï¼š**

- å°è¯•åŒæ­¥å°šæœªåœ¨æœ¬åœ°åˆ›å»ºçš„æ–‡æ¡£

**è§£å†³æ–¹æ¡ˆï¼š**

- ç¡®ä¿å…ˆåœ¨æœ¬åœ°åˆ›å»ºæ–‡æ¡£
- æ£€æŸ¥ docId æ˜¯å¦æ­£ç¡®

---

#### é—®é¢˜ 4ï¼šåŒæ­¥é˜Ÿåˆ—å †ç§¯

**ç°è±¡ï¼š**

- åŒæ­¥çŠ¶æ€ä¸€ç›´æ˜¾ç¤º"å¾…åŒæ­¥"
- æ–‡æ¡£æœªåŒæ­¥åˆ° AFFiNE

**åŸå› ï¼š**

- WebSocket è¿æ¥æ–­å¼€
- AFFiNE åç«¯ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆï¼š**

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
localStorage.removeItem('sync-queue');
// åˆ·æ–°é¡µé¢é‡æ–°åŒæ­¥
```

---

### è°ƒè¯•æŠ€å·§

#### 1. æ£€æŸ¥ IndexedDB

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const request = indexedDB.open('ai-editor-local', 1);
request.onsuccess = () => {
  const db = request.result;
  const tx = db.transaction('docs', 'readonly');
  const store = tx.objectStore('docs');
  const getAll = store.getAll();
  getAll.onsuccess = () => {
    console.log('æœ¬åœ°æ–‡æ¡£:', getAll.result);
  };
};
```

#### 2. æ£€æŸ¥åŒæ­¥é˜Ÿåˆ—

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const queue = localStorage.getItem('sync-queue');
console.log('åŒæ­¥é˜Ÿåˆ—:', JSON.parse(queue));
```

#### 3. æ£€æŸ¥ WebSocket è¿æ¥

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
console.log('WebSocket çŠ¶æ€:', window.socket?.connected);
```

#### 4. æ¸…ç©ºæ‰€æœ‰æ•°æ®

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
localStorage.clear();
indexedDB.deleteDatabase('ai-editor-local');
location.reload();
```

---

## ğŸ“Š API å‚è€ƒ

### DocumentService API

```typescript
class DocumentService {
  // åˆ›å»ºæ–‡æ¡£
  createDoc(
    title: string,
    options?: {
      workspaceId?: string;
      ownerId?: string;
      initialBlocks?: Block[];
    }
  ): Promise<string>;

  // è·å–æ–‡æ¡£
  getDoc(docId: string): Promise<Document | null>;

  // æ›´æ–°æ–‡æ¡£
  updateDoc(
    docId: string,
    updates: {
      title?: string;
      blocks?: Block[];
      yjsState?: Uint8Array;
    }
  ): Promise<void>;

  // åˆ é™¤æ–‡æ¡£
  deleteDoc(docId: string): Promise<void>;

  // åˆ—å‡ºæ–‡æ¡£
  listDocs(filter?: { workspaceId?: string; ownerId?: string; searchQuery?: string; updatedAfter?: number }): Promise<Document[]>;

  // æœç´¢æ–‡æ¡£
  searchDocs(query: string): Promise<Document[]>;

  // åˆ‡æ¢å­˜å‚¨æ¨¡å¼
  switchStorageMode(
    mode: 'local' | 'affine',
    config?: {
      workspaceId: string;
      token: string;
      serverUrl?: string;
    }
  ): Promise<void>;

  // åŒæ­¥åˆ° AFFiNE
  syncToAFFine(): Promise<void>;

  // è·å–åŒæ­¥ç»Ÿè®¡
  getSyncStats(): {
    pending: number;
    completed: number;
    failed: number;
  };
}
```

### AuthService API

```typescript
class AuthService {
  // ä¿å­˜ token
  saveToken(token: string, workspaceId?: string): void;

  // è·å– token
  getToken(): string | null;

  // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
  isAuthenticated(): boolean;

  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUser(): {
    email: string;
    token: string;
  } | null;

  // ç™»å‡º
  signOut(): Promise<void>;

  // è·å– workspace IDs
  getWorkspaces(): string[];
}
```

### SyncManager API

```typescript
class SyncManager {
  // é…ç½® AFFiNE
  async setConfig(config: { workspaceId: string; token: string; serverUrl?: string }): Promise<void>;

  // æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
  enqueue(operation: { type: 'create' | 'update' | 'delete'; doc?: Document; docId?: string; updates?: any }): void;

  // å¤„ç†åŒæ­¥é˜Ÿåˆ—
  async process(docId?: string): Promise<void>;

  // è·å–æ–‡æ¡£åŒæ­¥çŠ¶æ€
  getStatus(docId: string): 'idle' | 'pending' | 'synced' | 'error';

  // è·å–åŒæ­¥ç»Ÿè®¡
  getStats(): {
    total: number;
    pending: number;
    processing: number;
    completed: number;
    failed: number;
  };

  // æ¸…ç©ºé˜Ÿåˆ—
  clearQueue(): void;

  // æ–­å¼€è¿æ¥
  async disconnect(): Promise<void>;
}
```

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 3. è®¿é—®åº”ç”¨
# http://localhost:3004
```

### ç”Ÿäº§ç¯å¢ƒæ„å»º

```bash
# 1. æ„å»º
npm run build

# 2. è¾“å‡ºç›®å½•
# dist/

# 3. éƒ¨ç½²åˆ°é™æ€æœåŠ¡å™¨
# ä¾‹å¦‚ï¼šnginx, apache, vercel, netlify
```

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# AFFiNE åç«¯é…ç½®
VITE_AFFINE_SERVER_URL=http://localhost:10003
VITE_AFFINE_GRAPHQL_URL=http://localhost:10003/graphql
VITE_AFFINE_WS_URL=ws://localhost:10003/graphql

# åº”ç”¨é…ç½®
VITE_APP_NAME=AFFiNE AI Editor
VITE_APP_VERSION=1.0.0
```

---

## ğŸ“ é…ç½®è¯´æ˜

### AFFiNE åç«¯é…ç½®

**æœ¬åœ°å¼€å‘ï¼ˆæ¨èï¼‰ï¼š**

```
é€šè¿‡ SSH tunnel è½¬å‘ AFFiNE åç«¯
æœ¬åœ°ç«¯å£ï¼š10003
è¿œç¨‹ç«¯å£ï¼š3000ï¼ˆAFFiNE é»˜è®¤ç«¯å£ï¼‰
```

**SSH tunnel å‘½ä»¤ï¼š**

```bash
ssh -L 10003:localhost:3000 user@affine-server
```

### å­˜å‚¨é…ç½®

**æœ¬åœ°æ¨¡å¼ï¼š**

- æ— éœ€é…ç½®
- è‡ªåŠ¨ä½¿ç”¨ IndexedDB

**AFFiNE åŒæ­¥æ¨¡å¼ï¼š**

```javascript
{
  workspaceId: '8ebdecc7-227f-4415-85b5-9630bc2c7bda',
  token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  serverUrl: 'http://localhost:10003'
}
```

---

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### Token ç®¡ç†

- âœ… Token ä¿å­˜åœ¨ localStorageï¼ˆå¯é…ç½®ä¸ºæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
- âœ… Token åªåœ¨æœ¬åœ°ä½¿ç”¨ï¼Œä¸ä¼šå‘é€åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡å™¨
- âš ï¸ å»ºè®®å®šæœŸæ›´æ–° Token
- âš ï¸ ä¸è¦åœ¨å…¬å…±è®¾å¤‡ä¸Šä¿å­˜ Token

### æ•°æ®éšç§

- âœ… æœ¬åœ°æ•°æ®å®Œå…¨åœ¨æµè§ˆå™¨ä¸­
- âœ… äº‘ç«¯æ•°æ®ä½¿ç”¨åŠ å¯†ä¼ è¾“ï¼ˆWSSï¼‰
- âš ï¸ å»ºè®®åœ¨ AFFiNE åç«¯å¯ç”¨ HTTPS

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°çš„ä¼˜åŒ–

1. **è‡ªåŠ¨ä¿å­˜å»¶è¿Ÿ**
   - 1ç§’å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹ä¿å­˜
   - å‡å°‘æœ¬åœ°å­˜å‚¨å†™å…¥

2. **åŒæ­¥é˜Ÿåˆ—**
   - å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ UI
   - æ‰¹é‡å¤„ç†åŒæ­¥æ“ä½œ

3. **å¢é‡åŒæ­¥**
   - ä½¿ç”¨ Yjs çš„ diff æœºåˆ¶
   - åªä¼ è¾“å˜åŒ–éƒ¨åˆ†

4. **æœ¬åœ°ä¼˜å…ˆ**
   - æ“ä½œç«‹å³åæ˜ åˆ°æœ¬åœ°
   - äº‘ç«¯åŒæ­¥åœ¨åå°è¿›è¡Œ

### å¯é€‰ä¼˜åŒ–

1. **æ‰¹é‡åŒæ­¥**

   ```typescript
   // å°†å¤šä¸ªæ›´æ–°åˆå¹¶ä¸ºä¸€ä¸ªåŒæ­¥æ“ä½œ
   batchSync(docIds: string[]): Promise<void>
   ```

2. **å‹ç¼©ä¼ è¾“**

   ```typescript
   // å‹ç¼© Yjs äºŒè¿›åˆ¶æ•°æ®
   compress(update: Uint8Array): Uint8Array
   ```

3. **æ‡’åŠ è½½**
   ```typescript
   // åªåœ¨éœ€è¦æ—¶åŠ è½½æ–‡æ¡£
   lazyLoad(docId: string): Promise<Document>
   ```

---

## ğŸ§© æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„å­˜å‚¨é€‚é…å™¨

```typescript
// 1. å®ç° IStorageAdapter æ¥å£
class MySQLStorageAdapter implements IStorageAdapter {
  async getDoc(docId: string): Promise<Document | null> {
    // å®ç°
  }

  async createDoc(doc: Document): Promise<void> {
    // å®ç°
  }

  // ... å…¶ä»–æ–¹æ³•
}

// 2. åœ¨ DocumentService ä¸­æ³¨å†Œ
documentService.registerAdapter('mysql', new MySQLStorageAdapter());
```

### æ·»åŠ æ–°çš„åŒæ­¥åè®®

```typescript
// 1. å®ç° SyncProtocol æ¥å£
class WebRTCSyncProtocol implements SyncProtocol {
  async send(update: Uint8Array): Promise<void> {
    // WebRTC å®ç°
  }

  async receive(): Promise<Uint8Array> {
    // å®ç°
  }
}

// 2. åœ¨ SyncManager ä¸­ä½¿ç”¨
syncManager.setProtocol(new WebRTCSyncProtocol());
```

---

## ğŸ“š æŠ€æœ¯æ ˆæ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯

| æŠ€æœ¯             | ç‰ˆæœ¬   | ç”¨é€”             |
| ---------------- | ------ | ---------------- |
| React            | 18.x   | UI æ¡†æ¶          |
| TypeScript       | 5.x    | ç±»å‹ç³»ç»Ÿ         |
| Socket.IO Client | 4.8.x  | WebSocket å®¢æˆ·ç«¯ |
| Yjs              | 13.6.x | CRDT æ•°æ®ç»“æ„    |
| IndexedDB        | -      | æœ¬åœ°å­˜å‚¨         |

### ä¾èµ–çš„ AFFiNE ç»„ä»¶

| ç»„ä»¶                 | ç”¨é€”           |
| -------------------- | -------------- |
| AFFiNE Backend       | äº‘ç«¯å­˜å‚¨å’ŒåŒæ­¥ |
| AFFiNE WebSocket API | å®æ—¶é€šä¿¡       |
| AFFiNE GraphQL API   | å…ƒæ•°æ®æŸ¥è¯¢     |

### æ•°æ®æ ¼å¼

| æ ¼å¼       | ç”¨é€”           |
| ---------- | -------------- |
| JSON       | æœ¬åœ°å­˜å‚¨æ ¼å¼   |
| Yjs Binary | äº‘ç«¯ä¼ è¾“æ ¼å¼   |
| Base64     | WebSocket ç¼–ç  |

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§æ€»ç»“

### å·²å®ç° âœ…

- [x] åŒç¼–è¾‘å™¨æ¨¡å¼ï¼ˆå®Œæ•´ + è½»é‡ï¼‰
- [x] æœ¬åœ°å­˜å‚¨ï¼ˆIndexedDBï¼‰
- [x] æ–‡æ¡£ CRUD æ“ä½œ
- [x] è‡ªåŠ¨ä¿å­˜
- [x] AFFiNE è®¤è¯
- [x] WebSocket è¿æ¥
- [x] Yjs æ ¼å¼è½¬æ¢
- [x] åŒå‘åŒæ­¥
- [x] åŒæ­¥é˜Ÿåˆ—ç®¡ç†
- [x] é”™è¯¯é‡è¯•æœºåˆ¶
- [x] ç¦»çº¿ç¼–è¾‘
- [x] æœç´¢åŠŸèƒ½
- [x] è®¾ç½®é¢æ¿

### è®¡åˆ’ä¸­ ğŸš§

- [ ] å®æ—¶åä½œæ„ŸçŸ¥
- [ ] å†å²ç‰ˆæœ¬æŸ¥çœ‹
- [ ] æ–‡æ¡£å¯¼å‡ºï¼ˆMarkdown, PDFï¼‰
- [ ] æ–‡æ¡£å¯¼å…¥
- [ ] æ‰¹é‡æ“ä½œ
- [ ] å›æ”¶ç«™åŠŸèƒ½
- [ ] æ ‡ç­¾ç³»ç»Ÿ

---

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

### é—®é¢˜åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼š

1. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º
2. **æŸ¥çœ‹æ–‡æ¡£**ï¼šå‚è€ƒæœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
3. **æä¾›ä¿¡æ¯**ï¼š
   - æµè§ˆå™¨ç±»å‹å’Œç‰ˆæœ¬
   - é”™è¯¯ä¿¡æ¯ï¼ˆæ§åˆ¶å°æˆªå›¾ï¼‰
   - å¤ç°æ­¥éª¤
   - é…ç½®ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰

---

## ğŸ“„ ç‰ˆæœ¬å†å²

### v1.0.0 (å½“å‰ç‰ˆæœ¬)

**æ–°å¢åŠŸèƒ½ï¼š**

- âœ… å®Œæ•´çš„å—ç¼–è¾‘å™¨
- âœ… è½»é‡çº§ç¼–è¾‘å™¨
- âœ… æœ¬åœ°å­˜å‚¨æ”¯æŒ
- âœ… AFFiNE WebSocket åŒæ­¥
- âœ… Yjs æ ¼å¼è½¬æ¢
- âœ… åŒå‘åŒæ­¥æœºåˆ¶
- âœ… è®¤è¯ç³»ç»Ÿ
- âœ… è®¾ç½®é¢æ¿

**ä¿®å¤é—®é¢˜ï¼š**

- ä¿®å¤æ–‡æ¡£è‡ªåŠ¨åˆ›å»ºé€»è¾‘
- ä¿®å¤ React key è­¦å‘Š
- ä¿®å¤ç±»å‹å®šä¹‰
- ä¼˜åŒ–é”™è¯¯å¤„ç†

**å·²çŸ¥é™åˆ¶ï¼š**

- ä¸æ”¯æŒå®æ—¶åä½œæ„ŸçŸ¥ï¼ˆå…‰æ ‡ä½ç½®ç­‰ï¼‰
- Yjs æ–‡æ¡£åœ¨ AFFiNE ä¸­å¯èƒ½éœ€è¦æ ¼å¼åŒ–æ˜¾ç¤º
- åŒæ­¥å¤±è´¥æ—¶éœ€è¦æ‰‹åŠ¨é‡è¯•

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. æ··åˆå­˜å‚¨æ¶æ„

**è®¾è®¡ç†å¿µï¼š**

- æœ¬åœ°ä¼˜å…ˆï¼šå¿«é€Ÿå“åº”ï¼Œç¦»çº¿å¯ç”¨
- äº‘ç«¯åŒæ­¥ï¼šæ•°æ®å®‰å…¨ï¼Œè·¨è®¾å¤‡è®¿é—®
- é€æ˜åˆ‡æ¢ï¼šç”¨æˆ·æ— æ„ŸçŸ¥çš„å­˜å‚¨æ¨¡å¼åˆ‡æ¢

**æŠ€æœ¯å®ç°ï¼š**

```typescript
interface IStorageAdapter {
  getDoc(docId: string): Promise<Document | null>;
  createDoc(doc: Document): Promise<void>;
  updateDoc(docId: string, updates: DocUpdates): Promise<void>;
  deleteDoc(docId: string): Promise<void>;
  listDocs(filter?: DocFilter): Promise<Document[]>;
}
```

### 2. Yjs CRDT é›†æˆ

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**

- è‡ªåŠ¨å†²çªè§£å†³
- å¢é‡æ›´æ–°ä¼ è¾“
- æ”¯æŒç¦»çº¿ç¼–è¾‘ååˆå¹¶

**æ•°æ®æµï¼š**

```
ç”¨æˆ·ç¼–è¾‘ â†’ JSON æ ¼å¼
    â†“
YjsConverter â†’ Yjs Doc
    â†“
encodeStateAsUpdate() â†’ Uint8Array
    â†“
Base64 ç¼–ç  â†’ WebSocket â†’ AFFiNE
```

### 3. é˜Ÿåˆ—åŒ–åŒæ­¥

**è®¾è®¡æ¨¡å¼ï¼š**

- å¼‚æ­¥é˜Ÿåˆ—ï¼šä¸é˜»å¡ UI
- é‡è¯•æœºåˆ¶ï¼šæœ€å¤š 3 æ¬¡
- ä¼˜å…ˆçº§å¤„ç†ï¼šæ–‡æ¡£çº§åˆ«

**å®ç°ï¼š**

```typescript
class SyncManager {
  private queue: SyncQueueItem[] = [];

  async process(): Promise<void> {
    for (const item of this.queue) {
      try {
        await this.executeOperation(item.operation);
        item.status = 'completed';
      } catch (error) {
        if (item.retries < 3) {
          item.retries++;
          item.status = 'pending';
        } else {
          item.status = 'failed';
        }
      }
    }
  }
}
```

---

## ğŸ† æ€»ç»“

### é¡¹ç›®æˆå°±

1. **å®Œæ•´çš„åŒç¼–è¾‘å™¨ç³»ç»Ÿ**ï¼šæä¾›å®Œæ•´å’Œè½»é‡ä¸¤ç§é€‰æ‹©
2. **å¯é çš„å­˜å‚¨æ–¹æ¡ˆ**ï¼šæœ¬åœ° IndexedDB + äº‘ç«¯åŒé‡ä¿éšœ
3. **æ™ºèƒ½åŒæ­¥æœºåˆ¶**ï¼šåŸºäº Yjs çš„ CRDT åŒæ­¥ï¼Œè‡ªåŠ¨å†²çªè§£å†³
4. **ç¦»çº¿ä¼˜å…ˆè®¾è®¡**ï¼šæ— éœ€ç½‘ç»œå³å¯ä½¿ç”¨
5. **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨ä¿å­˜ã€å®æ—¶åŒæ­¥ã€é”™è¯¯æ¢å¤

### é€‚ç”¨åœºæ™¯

- âœ… ä¸ªäººç¬”è®°å’Œæ–‡æ¡£ç®¡ç†
- âœ… éœ€è¦äº‘ç«¯å¤‡ä»½çš„ç¦»çº¿ç¼–è¾‘å™¨
- âœ… AFFiNE ç”Ÿæ€çš„è½»é‡çº§å®¢æˆ·ç«¯
- âœ… å¤šè®¾å¤‡æ–‡æ¡£åŒæ­¥
- âœ… AI è¾…åŠ©å†™ä½œå’Œç¼–è¾‘

### æŠ€æœ¯ç‰¹è‰²

- ğŸ¯ **æ··åˆæ¶æ„**ï¼šç»“åˆæœ¬åœ°å’Œäº‘ç«¯ä¼˜åŠ¿
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šå¼‚æ­¥å¤„ç†ã€å¢é‡æ›´æ–°
- ğŸ”’ **æ•°æ®å®‰å…¨**ï¼šåŠ å¯†ä¼ è¾“ã€æœ¬åœ°å¤‡ä»½
- ğŸ”§ **æ˜“äºæ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ã€æ¥å£æ¸…æ™°
- ğŸ“± **å“åº”å¼è®¾è®¡**ï¼šé€‚é…å„ç§è®¾å¤‡

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0.0
**æœ€åæ›´æ–°ï¼š** 2025-01-17
**ç»´æŠ¤è€…ï¼š** AI Editor Team
