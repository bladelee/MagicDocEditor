# 对接计划评审报告

**评审日期**: 2025-01-16
**评审文档**: backend-integration-plan.md
**需求文档**: ai编辑器需求文档.md

---

## 📋 评审总结

### 核心需求对比

| 需求模块         | 用户故事                          | 对接计划覆盖 | 状态       |
| ---------------- | --------------------------------- | ------------ | ---------- |
| **文档基础编辑** | US-001: 手动创建并编辑文档        | ✅ 完全覆盖  | 符合       |
| **文档基础编辑** | US-002: 文档格式预览与排版优化    | ✅ 完全覆盖  | 符合       |
| **AI功能**       | US-003: AI Chat生成完整文档       | ✅ 完全覆盖  | 符合       |
| **AI功能**       | US-004: AI Chat局部修改文档内容   | ⚠️ 部分覆盖  | **需确认** |
| **AI功能**       | US-005: Prompt模板生成文档        | ❌ 未覆盖    | **缺失**   |
| **文档管理**     | US-006: 文档创建/重命名/删除/移动 | ✅ 完全覆盖  | 符合       |
| **文档管理**     | US-007: 文档版本回溯              | ❌ 未覆盖    | **需确认** |
| **性能兼容**     | US-014: 系统性能要求              | ⚠️ 部分覆盖  | **需补充** |
| **性能兼容**     | US-015: 浏览器兼容性              | ⚠️ 部分覆盖  | **需补充** |
| **数据安全**     | US-016: 数据安全与备份            | ✅ 完全覆盖  | 符合       |

---

## ⚠️ 问题条目清单

### 问题 1: AI 局部修改功能的 AFFiNE API 支持不明确

**需求描述**:

- **US-004: AI Chat局部修改文档内容**
  - 支持选中任意文本段落，右键或工具栏触发「AI修改」
  - 支持修改指令：改写、总结、翻译、纠错
  - AI返回修改结果后，提供「替换选中内容」「插入到选中位置后」「取消」三个选项
  - 多次局部修改可在Chat面板保留对话上下文

**对接计划当前状态**:

```typescript
// src/web/services/ai.service.ts
async improve(content: string): Promise<string>
async summarize(content: string): Promise<string>
async translate(content: string, targetLang: string): Promise<string>
```

**问题**:

1. ❓ AFFiNE 后端是否提供 `improve`、`summarize`、`translate` 这些 GraphQL mutation？
2. ❓ AFFiNE 后端的 AI Chat 是否支持对话上下文保持？
3. ❓ AFFiNE 后端是否支持流式输出用于局部修改？

**建议**:

- 需要验证 AFFiNE GraphQL schema 中是否包含这些 mutation
- 如果没有，需要通过 AFFiNE 的 Copilot API 调用外部 AI 服务（OpenAI/Gemini）
- 对话上下文可能需要前端维护（Apollo Cache 或本地状态）

---

### 问题 2: Prompt 模板功能未在对接计划中体现

**需求描述**:

- **US-005: Prompt模板生成文档**
  - AI Chat面板提供「模板库」入口，展示分类模板（如工作汇报、营销文案、技术文档）
  - 选择模板后，提示输入关键参数（如汇报周期、核心主题、目标受众）
  - 模板内容基于MD格式存储，支持管理员更新维护
  - 支持收藏常用模板

**对接计划当前状态**:

- ❌ 对接计划中完全未提及 Prompt 模板功能

**问题**:

1. ❓ Prompt 模板数据存储在哪里？本地？后端？
2. ❓ AFFiNE 后端是否有 `listCopilotPrompts` query 返回模板列表？
3. ❓ 模板参数化和生成逻辑由谁处理？前端还是后端？

**建议**:

- 需要补充 Prompt 模板管理的服务层设计
- 明确模板存储方案（推荐：AFFiNE 后端存储 + 前端缓存）
- 实现模板参数化和生成逻辑

---

### 问题 3: 文档版本回溯功能的 AFFiNE API 支持待确认

**需求描述**:

- **US-007: 文档版本回溯**
  - 系统自动记录文档版本（每30分钟或内容变更≥10字符触发版本创建）
  - 文档详情页提供「版本历史」入口，展示所有版本列表
  - 支持"回溯至该版本"，回溯后生成新版本
  - 版本历史至少保留30天，付费用户可延长至90天

**对接计划当前状态**:

```typescript
// 对接计划中未提及文档版本管理相关 API
```

**问题**:

1. ❓ AFFiNE 后端是否有文档版本管理的 GraphQL API？
2. ❓ 是否有类似 `docVersions` query 和 `restoreDocVersion` mutation？
3. ❓ 版本保留策略（30天/90天）是由后端控制还是需要前端实现？

**建议**:

- 需要调研 AFFiNE 的 Snapshot/Version 功能
- 如果后端不支持，可能需要：
  - 方案A：使用文档的 `updatedDate` 和 `createdDate` 实现简单的版本跟踪
  - 方案B：在前端实现版本管理（localStorage 存储）
  - 方案C：调用 AFFiNE 的历史记录 API（如果存在）

---

### 问题 4: 性能要求的监控和测试计划不完整

**需求描述**:

- **US-014: 系统性能要求**
  - 页面加载时间≤2秒（首次）、≤1秒（二次）
  - 文档编辑延迟≤100ms
  - AI流式输出首字符时间≤3秒
  - 数据库查询响应时间≤300ms
  - AI接口请求响应时间≤5秒

**对接计划当前状态**:

```typescript
// src/web/utils/monitor.ts
export class APIMonitor {
  recordRequest(duration: number, success: boolean);
  getMetrics();
}
```

**问题**:

1. ⚠️ 监控已实现，但**缺少具体的性能测试计划**
2. ⚠️ 缺少性能指标的阈值配置
3. ⚠️ 缺少性能告警机制

**建议**:

- 补充性能测试脚本（使用 Lighthouse、K6 等）
- 配置性能指标阈值和告警
- 在 CI/CD 中集成性能测试

---

### 问题 5: 嵌入场景的性能优化考虑不足

**需求描述**:

- **US-014: 嵌入场景性能**
  - 嵌入场景下加载时间≤3秒
  - 不阻塞宿主应用渲染
  - 嵌入后不拖慢宿主应用性能

**对接计划当前状态**:

- 提到了 Web Components 和 Shadow DOM 样式隔离
- 但**未详细说明性能优化措施**

**问题**:

1. ⚠️ 如何确保编辑器加载不阻塞宿主应用？
2. ⚠️ 如何优化编辑器的包体积和加载速度？
3. ⚠️ 如何减少嵌入场景的内存占用？

**建议**:

- 补充性能优化方案：
  - 代码分割（lazy loading）
  - 虚拟滚动（长文档优化）
  - Web Worker（AI 处理）
  - 资源预加载策略
- 明确包体积预算（如：<500KB gzipped）

---

### 问题 6: Mock 模式覆盖的测试场景需要明确

**需求描述**:

- US-003 到 US-007 所有功能都需要测试

**对接计划当前状态**:

```typescript
// src/config/mock.ts
ai: {
  chat: boolean,
  summarize: boolean,
  improve: boolean,
  translate: boolean,
  generateDoc: boolean,
}
```

**问题**:

1. ❓ Mock 模式是否需要覆盖所有需求场景？
2. ❓ Mock 数据是否需要模拟边界情况（如超长文档、特殊字符）？
3. ❓ Mock 模式是否需要模拟网络错误和重试？

**建议**:

- 明确 Mock 测试覆盖范围
- 设计 Mock 数据生成器，覆盖：
  - 正常场景
  - 边界场景（超长文本、特殊字符）
  - 异常场景（网络错误、超时）
- 编写 Mock 测试用例清单

---

### 问题 7: AFFiNE 后端的 AI 模型选择和配额管理

**需求描述**:

- **US-003: AI模型选择**
  - 支持选择AI模型（OpenAI GPT-3.5/4o、Gemini Pro）
  - 默认使用GPT-3.5
  - 生成记录计入AI使用配额，消耗Token数实时统计

**对接计划当前状态**:

```typescript
// 对接计划中未提及模型选择和配额管理
```

**问题**:

1. ❓ AFFiNE 后端是否支持模型选择？还是由前端直接调用 AI API？
2. ❓ Token 配额统计是在 AFFiNE 后端还是需要自己实现？
3. ❓ 如何实时统计和展示 Token 消耗？

**建议**:

- 需要明确 AI 调用架构：
  - 方案A：通过 AFFiNE 的 Copilot API（统一管理）
  - 方案B：前端直接调用 OpenAI/Gemini API（灵活但需要自己管理 key）
- 实现配额统计和展示功能
- 添加模型选择 UI

---

### 问题 8: 对接计划包含需求文档中不需要的功能

**需求文档中未明确要求的功能**:

1. ❓ **协作编辑**
   - 对接计划中提到了 WebSocket 协作光标订阅
   - 需求文档中未明确要求多用户实时协作

2. ❓ **数据库视图**
   - 对接计划中提到数据库视图功能
   - 需求文档中未提及

3. ❓ **思维导图、幻灯片**
   - 对接计划中列为"待实现"功能
   - 需求文档中未提及

**建议**:

- 明确这些功能是否为后续需求
- 如果不是，可以从对接计划中移除，减少复杂度
- 如果是后续需求，标注为"Phase 2 功能"

---

### 问题 9: 嵌入场景的认证适配细节需要明确

**需求描述**:

- **US-001: 嵌入场景认证**
  - 嵌入场景下可关联宿主应用用户身份
  - 嵌入后配额关联宿主应用用户账号

**对接计划当前状态**:

```typescript
// 支持多种认证方式，但未明确嵌入场景的用户映射
```

**问题**:

1. ❓ 嵌入场景下，如何将宿主应用的用户 ID 映射到 AFFiNE 的用户系统？
2. ❓ 是否需要实现用户同步机制？
3. ❓ 配额统计如何关联到宿主应用的用户账号？

**建议**:

- 设计用户身份映射方案：
  - 方案A：宿主应用用户 → AFFiNE 用户（1:1 映射）
  - 方案B：宿主应用用户 → AFFiNE 临时用户（token 关联）
- 实现用户同步或 token 关联机制
- 明确配额归属和统计逻辑

---

### 问题 10: 代码块语法高亮的实现方案

**需求描述**:

- **US-002: 代码块语法高亮**
  - 代码块支持语法高亮（至少覆盖TS/JS/HTML/CSS/Markdown）
  - 嵌入后高亮样式与宿主应用无冲突

**对接计划当前状态**:

```typescript
// 未提及语法高亮实现
```

**问题**:

1. ❓ 语法高亮使用哪个库？（Prism.js、Highlight.js、Shiki？）
2. ❓ 如何确保样式不与宿主应用冲突？
3. ❓ Shadow DOM 内的样式隔离是否足够？

**建议**:

- 选择语法高亮库（推荐：Shiki，使用 TextMate 主题）
- 明确样式隔离方案
- 测试嵌入场景下的样式冲突

---

## ✅ 符合需求的部分

以下部分在对接计划中已经符合需求：

### 1. 文档基础编辑 (US-001, US-002)

- ✅ 完整的文档 CRUD API
- ✅ 自动保存机制（5秒间隔）
- ✅ 撤销/重做（50步）
- ✅ 格式调整支持

### 2. AI Chat 生成完整文档 (US-003)

- ✅ AI Chat 面板
- ✅ 流式输出支持
- ✅ WebSocket 订阅
- ✅ 取消生成功能

### 3. 文档管理 (US-006)

- ✅ 创建/重命名/删除
- ✅ 移动文档
- ✅ 文档列表和搜索

### 4. 数据安全 (US-016)

- ✅ HTTPS 加密
- ✅ PostgreSQL 存储
- ✅ 备份策略

### 5. 嵌入集成架构

- ✅ Web Components 方案
- ✅ Shadow DOM 样式隔离
- ✅ 事件通信协议

---

## 📝 优先级分类

### 🔴 高优先级（必须解决）

1. **问题 1**: AI 局部修改的 AFFiNE API 支持
   - 影响：核心功能
   - 风险：API 不存在需要重新设计

2. **问题 2**: Prompt 模板功能
   - 影响：核心需求
   - 风险：完全缺失

3. **问题 7**: AI 模型选择和配额管理
   - 影响：用户体验和成本控制
   - 风险：架构不明确

4. **问题 9**: 嵌入场景的认证适配
   - 影响：嵌入集成的核心
   - 风险：用户映射不清晰

### 🟡 中优先级（建议解决）

5. **问题 3**: 文档版本回溯
   - 影响：用户数据安全
   - 风险：可能需要自己实现

6. **问题 5**: 嵌入场景性能优化
   - 影响：用户体验
   - 风险：性能不达标

7. **问题 10**: 代码块语法高亮
   - 影响：基础编辑功能
   - 风险：实现细节

### 🟢 低优先级（可以后续优化）

8. **问题 4**: 性能测试计划
   - 影响：质量保障
   - 风险：可以逐步完善

9. **问题 6**: Mock 测试覆盖
   - 影响：开发效率
   - 风险：可以逐步补充

10. **问题 8**: 不需要的功能
    - 影响：复杂度
    - 风险：可以移除

---

## 🎯 建议的后续行动

### 立即行动（本周内）

1. **验证 AFFiNE API 能力**

   ```bash
   # 查询 AFFiNE GraphQL schema
   curl -X POST http://localhost:10003/graphql \
     -H "Content-Type: application/json" \
     -d '{"query": "{ __schema { mutationType { fields { name } } } }"}'

   # 检查是否存在这些 mutation：
   # - chat, summarize, improve, translate
   # - listCopilotPrompts
   # - docVersions, restoreDocVersion
   ```

2. **调研 AFFiNE Copilot API**
   - 阅读 AFFiNE Copilot 文档
   - 确认 AI 功能的调用方式
   - 确认模型选择和配额管理

3. **设计 Prompt 模板方案**
   - 确定模板存储位置
   - 设计模板数据结构
   - 实现模板管理服务

### 短期行动（2周内）

4. **补充缺失功能设计**
   - Prompt 模板功能
   - 文档版本管理
   - 代码块语法高亮

5. **明确嵌入场景方案**
   - 用户身份映射
   - 性能优化措施
   - 样式隔离测试

6. **完善测试计划**
   - Mock 测试覆盖
   - 性能测试脚本
   - 集成测试用例

### 中期行动（1个月内）

7. **移除不需要的功能**
   - 协作编辑（如果不需要）
   - 数据库视图
   - 思维导图、幻灯片

8. **优化性能监控**
   - 添加性能阈值配置
   - 实现性能告警
   - 集成 CI/CD 性能测试

---

## 📊 风险评估

| 风险项                    | 影响 | 概率 | 缓解措施                   |
| ------------------------- | ---- | ---- | -------------------------- |
| AFFiNE 不支持局部修改 API | 高   | 中   | 前端实现 + 调用外部 AI API |
| Prompt 模板功能缺失       | 高   | 低   | 前端实现模板库             |
| 版本管理 API 不存在       | 中   | 中   | 前端实现简易版本管理       |
| 性能不达标                | 中   | 低   | 性能优化 + 代码分割        |
| 嵌入场景认证复杂          | 高   | 中   | 设计明确的用户映射方案     |

---

## ✅ 结论

**对接计划整体符合需求**，但需要补充以下关键内容：

1. ✅ 保留：文档基础编辑、文档管理、数据安全等已符合需求的部分
2. ⚠️ 补充：Prompt 模板、版本管理、性能优化、认证适配
3. ❓ 验证：AI 局部修改、模型选择、配额管理的 API 支持
4. ❌ 移除：协作编辑、数据库视图等不需要的功能
5. 🔧 优化：Mock 测试覆盖、性能监控、测试计划

建议优先解决高优先级问题，确保核心功能的实现可行性。
